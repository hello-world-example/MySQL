<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gtid | MySQL</title>


<link rel="stylesheet" href="/MySQL/book.min.a2277534155c5e81ce2c8ca6a4cd295525f25c75788a2e4e72c3310491c743b1.css">




<link rel="icon" href="/MySQL/favicon.png" type="image/x-icon">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://hello-world-example.github.io/MySQL/">MySQL</a>
</h2>






    
  
  
  

  <style>
  nav ul a[href$="\2fMySQL\2f docs\2f Binlog\2fGtid\2f "] {
      color: #004ed0;
  }
  </style>

<ul>
<li><strong>Install</strong>
<ul>
<li><a href="/MySQL/docs/Install/Mac-Multiple-Instance/">MAC 多实例安装 和 主从配置</a></li>
<li><a href="/MySQL/docs/Install/Docker-Multiple-Instance/">使用 Docker 搭建主从测试</a></li>
</ul>
</li>
<li><strong>JDBC</strong>
<ul>
<li><a href="/MySQL/docs/Jdbc/FetchSize/">FetchSize 处理大结果集</a></li>
<li><a href="/MySQL/docs/Jdbc/DataSource/">DataSource 配置</a></li>
</ul>
</li>
<li><strong>Better</strong>
<ul>
<li><a href="/MySQL/docs/Better/innodb_lock_wait_timeout/">锁等待时间</a></li>
<li><a href="/MySQL/docs/Better/wait_timeout/">链接超时时间</a></li>
</ul>
</li>
<li><strong>Binlog</strong>
<ul>
<li><a href="/MySQL/docs/Binlog/Quick-Start/">快速入门</a></li>
<li><a href="/MySQL/docs/Binlog/Gtid/">GTID</a></li>
<li><a href="/MySQL/docs/Binlog/binlog-protocol/">_binlog 协议</a></li>
<li><a href="/MySQL/docs/Binlog/parse-binlog-by-java/">_Java 解析 binlog</a></li>
<li><a href="/MySQL/docs/Binlog/parse-binlog-by-canal/">_Canal 订阅 binlog</a></li>
</ul>
</li>
<li><strong>Canal</strong>
<ul>
<li><a href="/MySQL/docs/canal/introduce/">Canal 简介</a></li>
<li><a href="/MySQL/docs/canal/data-type/">数据格式</a></li>
</ul>
</li>
<li><strong>其他</strong>
<ul>
<li><a href="/MySQL/docs/rds_dbsync/">MySQL 全量同步 Postgres</a></li>
</ul>
</li>
</ul>







</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/MySQL/svg/menu.svg" alt="Menu" />
  </label>
  <strong>Gtid</strong>
</header>

      
<article class="markdown"><h1 id="gtid">GTID</h1>
<p>GTID (Global Transaction ID) 是 MySQL5.6 引入的功能，可以在集群全局范围标识事务，<strong>用于取代过去通过binlog 文件偏移量定位复制位置的传统方式</strong>。</p>
<p>借助GTID，在发生主备切换的情况下，MySQL的其它Slave可以自动在新主上找到正确的复制位置，这<strong>大大简化了复杂复制拓扑下集群的维护，也减少了人为设置复制位置发生误操作的风险</strong>。另外，基于GTID的复制可以忽略已经执行过的事务，减少了数据发生不一致的风险。</p>
<p>GTID虽好，要想运用自如还需充分了解其原理与特性，特别要注意与<strong>传统的基于binlog文件偏移量复制方式</strong>不一样的地方。</p>
<h2 id="gtid长什么样">GTID长什么样</h2>
<p>根据官方文档定义，GTID由 <code>source_id</code> 加 <code>transaction_id</code> 构成。</p>
<pre><code>GTID = source_id:transaction_id 
</code></pre><p>上面的 <code>source_id</code> 指示发起事务的 MySQL 实例，值为该实例的 <code>server_uuid</code>。<code>server_uuid</code> 由MySQL在第一次启动时自动生成并被持久化到 <code>auto.cnf</code> 文件里，<code>transaction_id</code> 是MySQL实例上执行的事务序号，<strong>从 1 开始递增</strong>。 例如：</p>
<pre><code>e6954592-8dba-11e6-af0e-fa163e1cf111:1 
</code></pre><p>一组连续的事务可以用 <code>'-'</code> 连接的事务序号范围表示。例如</p>
<pre><code>e6954592-8dba-11e6-af0e-fa163e1cf111:1-5 
</code></pre><p>更一般的情况是GTID的集合。GTID集合可以包含来自多个 <code>source_id</code> 的事务，它们之间用逗号分隔；如果来自同一 <code>source_id</code> 的事务序号有多个范围区间，各组范围之间用冒号分隔，例如：</p>
<pre><code>e6954592-8dba-11e6-af0e-fa163e1cf111:1-5:11-18,e6954592-8dba-11e6-af0e-fa163e1cf3f2:1-27 
</code></pre><p>GTID集合拥有如下的形式定义：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">gtid_set:
    uuid_set [, uuid_set] ...
    <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;&#39;</span>

uuid_set:
    uuid:<span style="color:#66d9ef">interval</span>[:<span style="color:#66d9ef">interval</span>]...

uuid:
    hhhhhhhh<span style="color:#f92672">-</span>hhhh<span style="color:#f92672">-</span>hhhh<span style="color:#f92672">-</span>hhhh<span style="color:#f92672">-</span>hhhhhhhhhhhh

h:
    [<span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">9</span><span style="color:#f92672">|</span>A<span style="color:#f92672">-</span>F]

<span style="color:#66d9ef">interval</span>:
    n[<span style="color:#f92672">-</span>n]

    (n <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>)
</code></pre></div><h2 id="如何查看gtid">如何查看GTID</h2>
<p>可以通过MySQL的几个变量查看相关的GTID信息。</p>
<ul>
<li><code>gtid_executed</code> 在当前实例上执行过的GTID集合; 实际上包含了所有记录到binlog中的事务。所以，设置<code>set sql_log_bin=0</code> 后执行的事务不会生成 binlog 事件，也不会被记录到 gtid_executed 中。执行RESET MASTER 可以将该变量置空。</li>
<li><code>gtid_purged</code> binlog不可能永远驻留在服务上，需要定期进行清理，通过 <code>expire_logs_days</code> 可以控制定期清理间隔，否则迟早它会把磁盘用尽。<strong>gtid_purged 用于记录已经被清除了的binlog事务集合，它是gtid_executed的子集</strong>。只有 gtid_executed 为空时才能手动设置该变量，此时会同时更新 gtid_executed 为和gtid_purged相同的值。gtid_executed 为空意味着要么之前没有启动过基于GTID的复制，要么执行过RESET MASTER。执行 RESET MASTER 时同样也会把 gtid_purged 置空，即始终保持 gtid_purged 是gtid_executed 的子集。</li>
<li><code>gtid_next</code> 会话级变量，指示如何产生下一个GTID。可能的取值如下:
<ul>
<li><code>AUTOMATIC</code> 自动生成下一个GTID，实现上是分配一个当前实例上尚未执行过的序号最小的GTID。</li>
<li><code>ANONYMOUS</code> 设置后执行事务不会产生GTID。
<ul>
<li><code>显式指定的GTID</code> 可以指定任意形式合法的GTID值，但不能是当前gtid_executed中的已经包含的GTID，否则，下次执行事务时会报错。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>这些变量可以通过show命令查看，比如</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> global variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;gtid%&#39;</span>;
<span style="color:#f92672">+----------------------+------------------------------------------+</span>
<span style="color:#f92672">|</span> Variable_name        <span style="color:#f92672">|</span> Value                                    <span style="color:#f92672">|</span>
<span style="color:#f92672">+----------------------+------------------------------------------+</span>
<span style="color:#f92672">|</span> gtid_deployment_step <span style="color:#f92672">|</span> OFF                                      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> gtid_executed        <span style="color:#f92672">|</span> e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> gtid_mode            <span style="color:#f92672">|</span> <span style="color:#66d9ef">ON</span>                                       <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> gtid_owned           <span style="color:#f92672">|</span>                                          <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> gtid_purged          <span style="color:#f92672">|</span>                                          <span style="color:#f92672">|</span>
<span style="color:#f92672">+----------------------+------------------------------------------+</span>
<span style="color:#ae81ff">5</span> rows <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span>  variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;gtid_next&#39;</span>;
<span style="color:#f92672">+---------------+-----------+</span>
<span style="color:#f92672">|</span> Variable_name <span style="color:#f92672">|</span> Value     <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+-----------+</span>
<span style="color:#f92672">|</span> gtid_next     <span style="color:#f92672">|</span> AUTOMATIC <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+-----------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec) 
</code></pre></div><h2 id="如何产生gtid">如何产生GTID</h2>
<p>GTID 的生成受 <code>gtid_next</code> 控制。 在 Master 上，<code>gtid_next</code> 是默认的 <code>AUTOMATIC</code>，即在每次事务提交时自动生成新的 GTID。它从当前已执行的GTID集合（即 <code>gtid_executed</code>）中，找一个大于0的未使用的最小值作为下个事务GTID。同时在 binlog 的实际的更新事务事件前面插入一条 <code>set gtid_next</code> 事件。</p>
<p>以下是一条 insert 语句生成的 binlog 记录</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">use</span> <span style="color:#f92672">`</span>test<span style="color:#f92672">`</span>
<span style="color:#66d9ef">Database</span> changed

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> tbx1 <span style="color:#66d9ef">values</span>(<span style="color:#ae81ff">1</span>);
Query OK, <span style="color:#ae81ff">1</span> row <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> binlog events <span style="color:#66d9ef">IN</span> <span style="color:#e6db74">&#39;binlog.000015&#39;</span>;
<span style="color:#f92672">+---------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------+</span>
<span style="color:#f92672">|</span> Log_name      <span style="color:#f92672">|</span> Pos <span style="color:#f92672">|</span> Event_type     <span style="color:#f92672">|</span> Server_id <span style="color:#f92672">|</span> End_log_pos <span style="color:#f92672">|</span> Info                                                              <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------+</span>
...
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">707</span> <span style="color:#f92672">|</span> Gtid           <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">755</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SET</span> <span style="color:#f92672">@@</span>SESSION.GTID_NEXT<span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;e10c75be-5c1b-11e6-ab7c-000c296078ae:9&#39;</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">755</span> <span style="color:#f92672">|</span> Query          <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">834</span> <span style="color:#f92672">|</span> BEGIN                                                             <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">834</span> <span style="color:#f92672">|</span> Query          <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">934</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">use</span> <span style="color:#f92672">`</span>test<span style="color:#f92672">`</span>; <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> tbx1 <span style="color:#66d9ef">values</span>(<span style="color:#ae81ff">1</span>)                            <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">934</span> <span style="color:#f92672">|</span> Xid            <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">965</span> <span style="color:#f92672">|</span> COMMIT <span style="color:#75715e">/* xid=20 */</span>                                               <span style="color:#f92672">|</span> 
...
</code></pre></div><p><strong>在 Slave 上回放主库的 binlog 时，先执行 <code>set gtid_next …</code>，然后再执行真正的 insert 语句，确保在主和备上这条 insert 对应于相同的 GTID。</strong></p>
<p>一般情况下，GTID集合是连续的，但使用多线程复制(MTS)以及通过gtid_next进行人工干预时会导致gtid空洞。比如下面这样:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> master status;
<span style="color:#f92672">+---------------+----------+--------------+------------------+------------------------------------------+</span>
<span style="color:#f92672">|</span> File          <span style="color:#f92672">|</span> Position <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span> Executed_Gtid_Set                        <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+------------------------------------------+</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">965</span> <span style="color:#f92672">|</span>              <span style="color:#f92672">|</span>                  <span style="color:#f92672">|</span> e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">9</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+------------------------------------------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> gtid_next<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;e10c75be-5c1b-11e6-ab7c-000c296078ae:12&#39;</span>;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> begin;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> commit;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> gtid_next<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;AUTOMATIC&#39;</span>;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> master status;
<span style="color:#f92672">+---------------+----------+--------------+------------------+---------------------------------------------+</span>
<span style="color:#f92672">|</span> File          <span style="color:#f92672">|</span> Position <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span> Executed_Gtid_Set                           <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+---------------------------------------------+</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">1158</span> <span style="color:#f92672">|</span>              <span style="color:#f92672">|</span>                  <span style="color:#f92672">|</span> e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>:<span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+---------------------------------------------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec) 
</code></pre></div><p>继续执行事务，MySQL会分配一个最小的未使用GTID,也就是从出现空洞的地方分配GTID，最终会把空洞填上。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> tbx1 <span style="color:#66d9ef">values</span>(<span style="color:#ae81ff">1</span>);
Query OK, <span style="color:#ae81ff">1</span> row <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> master status;
<span style="color:#f92672">+---------------+----------+--------------+------------------+----------------------------------------------+</span>
<span style="color:#f92672">|</span> File          <span style="color:#f92672">|</span> Position <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span> Executed_Gtid_Set                            <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+----------------------------------------------+</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">1416</span> <span style="color:#f92672">|</span>              <span style="color:#f92672">|</span>                  <span style="color:#f92672">|</span> e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+----------------------------------------------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec) 
</code></pre></div><p>这意味着<strong>严格来说我们即不能假设GTID集合是连续的，也不能假定GTID序号大的事务在GTID序号小的事务之后执行，事务的顺序应由事务记录在binlog中的先后顺序决定</strong>。</p>
<h2 id="gtid限制">GTID限制</h2>
<ul>
<li>
<p>不支持非事务引擎</p>
<p>不支持非事务引擎 不是 不能建立 MyISAM 表、对 MyISAM 表DML，InnoDB 中一个事务中可以是多条 SQL，MyISAM 中，一条DML生成一个GTID号，所以说不支持事务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e">-- MyISAM 每条 SQL 自动提交，所以 MyISAM 中不存在事务的概念
</span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> user_myisam <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">100</span>);   
  
Executed_Gtid_Set: <span style="color:#ae81ff">59</span>fe7a3e<span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>dd6<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e7<span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>d6c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c29e57c69:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">68</span> 
</code></pre></div></li>
<li>
<p>不支持 <code>create table … select</code>  语句复制，主库会直接报错</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t1 <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> user_innodb;
  
ERROR <span style="color:#ae81ff">1786</span> (HY000): <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> ... <span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">is</span> forbidden <span style="color:#66d9ef">when</span> <span style="color:#f92672">@@</span>GLOBAL.ENFORCE_GTID_CONSISTENCY <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
</code></pre></div></li>
<li>
<p>不允许在一个SQL同时更新一个 事务引擎 和 非事务引擎 的表</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> begin;
  
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> user_innodb <span style="color:#66d9ef">set</span> money<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span> <span style="color:#66d9ef">where</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
  
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> user_myisam <span style="color:#66d9ef">set</span> money<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span> <span style="color:#66d9ef">where</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
  
ERROR <span style="color:#ae81ff">1785</span> (HY000): <span style="color:#66d9ef">When</span> <span style="color:#f92672">@@</span>GLOBAL.ENFORCE_GTID_CONSISTENCY <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, updates <span style="color:#66d9ef">to</span> non<span style="color:#f92672">-</span>transactional <span style="color:#66d9ef">tables</span> can only be done <span style="color:#66d9ef">in</span> either autocommitted statements <span style="color:#66d9ef">or</span> single<span style="color:#f92672">-</span>statement transactions, <span style="color:#66d9ef">and</span> never <span style="color:#66d9ef">in</span> the same statement <span style="color:#66d9ef">as</span> updates <span style="color:#66d9ef">to</span> transactional <span style="color:#66d9ef">tables</span>.
</code></pre></div></li>
<li>
<p>在一个复制组中，必须要求统一开启GTID或是关闭GTID</p>
</li>
<li>
<p>对于 <code>create temporary table</code> 和 <code>drop temporary table</code> 语句不支持</p>
</li>
<li>
<p>不支持 <code>sql_slave_skip_counter</code></p>
</li>
</ul>
<h2 id="gtid的持久化">GTID的持久化</h2>
<p>GTID相关的信息存储在binlog文件中，为此 MySQL5.6 新增了下面 2个 binlog 事件。</p>
<ul>
<li><code>Previous_gtids_log_event</code> 在每个binlog文件的开头部分，记录在该binlog文件之前已执行的GTID集合。</li>
<li><code>Gtid_log_event</code>  即前面看到的 <code>set gtid_next …</code>,它出现在每个事务的前面，表明下一个事务的gtid。</li>
</ul>
<p>示例如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> binlog events <span style="color:#66d9ef">IN</span> <span style="color:#e6db74">&#39;binlog.000015&#39;</span>;
<span style="color:#f92672">+---------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------+</span>
<span style="color:#f92672">|</span> Log_name      <span style="color:#f92672">|</span> Pos <span style="color:#f92672">|</span> Event_type     <span style="color:#f92672">|</span> Server_id <span style="color:#f92672">|</span> End_log_pos <span style="color:#f92672">|</span> Info                                                              <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------+</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span> Format_desc    <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">120</span> <span style="color:#f92672">|</span> Server ver: <span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">6</span>.<span style="color:#ae81ff">31</span><span style="color:#f92672">-</span><span style="color:#ae81ff">77</span>.<span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>log, Binlog ver: <span style="color:#ae81ff">4</span>                        <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">120</span> <span style="color:#f92672">|</span> Previous_gtids <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">191</span> <span style="color:#f92672">|</span> e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>                          <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">191</span> <span style="color:#f92672">|</span> Gtid           <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">239</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SET</span> <span style="color:#f92672">@@</span>SESSION.GTID_NEXT<span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;e10c75be-5c1b-11e6-ab7c-000c296078ae:7&#39;</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">239</span> <span style="color:#f92672">|</span> Query          <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">318</span> <span style="color:#f92672">|</span> BEGIN                                                             <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">318</span> <span style="color:#f92672">|</span> Query          <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">418</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">use</span> <span style="color:#f92672">`</span>test<span style="color:#f92672">`</span>; <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> tbx1 <span style="color:#66d9ef">values</span>(<span style="color:#ae81ff">1</span>)                            <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">418</span> <span style="color:#f92672">|</span> Xid            <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">449</span> <span style="color:#f92672">|</span> COMMIT <span style="color:#75715e">/* xid=13 */</span>                                               <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">449</span> <span style="color:#f92672">|</span> Gtid           <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">497</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SET</span> <span style="color:#f92672">@@</span>SESSION.GTID_NEXT<span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;e10c75be-5c1b-11e6-ab7c-000c296078ae:8&#39;</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">497</span> <span style="color:#f92672">|</span> Query          <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">576</span> <span style="color:#f92672">|</span> BEGIN                                                             <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">576</span> <span style="color:#f92672">|</span> Query          <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">676</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">use</span> <span style="color:#f92672">`</span>test<span style="color:#f92672">`</span>; <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> tbx1 <span style="color:#66d9ef">values</span>(<span style="color:#ae81ff">1</span>)                            <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">676</span> <span style="color:#f92672">|</span> Xid            <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">707</span> <span style="color:#f92672">|</span> COMMIT <span style="color:#75715e">/* xid=17 */</span>                                               <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">707</span> <span style="color:#f92672">|</span> Gtid           <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">755</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SET</span> <span style="color:#f92672">@@</span>SESSION.GTID_NEXT<span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;e10c75be-5c1b-11e6-ab7c-000c296078ae:9&#39;</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">755</span> <span style="color:#f92672">|</span> Query          <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">834</span> <span style="color:#f92672">|</span> BEGIN                                                             <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">834</span> <span style="color:#f92672">|</span> Query          <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">934</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">use</span> <span style="color:#f92672">`</span>test<span style="color:#f92672">`</span>; <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> tbx1 <span style="color:#66d9ef">values</span>(<span style="color:#ae81ff">1</span>)                            <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000015</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">934</span> <span style="color:#f92672">|</span> Xid            <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">965</span> <span style="color:#f92672">|</span> COMMIT <span style="color:#75715e">/* xid=20 */</span>                                               <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------+</span>
<span style="color:#ae81ff">14</span> rows <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec) 
</code></pre></div><p>MySQL服务器启动时，通过读binlog文件，初始化 <code>gtid_executed</code> 和 <code>gtid_purged</code> ,使它们的值能和上次MySQL运行时一致。</p>
<ul>
<li><code>gtid_executed</code> 被设置为最新的 binlog 文件中 <code>Previous_gtids_log_event</code> 和所有 <code>Gtid_log_event</code> 的并集。</li>
<li><code>gtid_purged</code> 为最老的binlog文件中 <code>Previous_gtids_log_event</code>。</li>
</ul>
<p>由于这两个重要的变量值记录在binlog中，所以开启 <code>gtid_mode</code> 时必须同时在主库上开启 <code>log_bin</code> 在备库上开启 <code>log_slave_updates</code>。但是，在MySQL5.7中没有这个限制。MySQL5.7中，新增加一个系统表<code>mysql.gtid_executed</code> 用于持久化已执行的GTID集合。当主库上没有开启 log_bin 或在备库上没有开启log_slave_updates 时，mysql.gtid_executed 会跟用户事务一起每次更新。否则只在binlog日志发生rotation时更新mysql.gtid_executed。</p>
<h2 id="如何配置基于gtid的复制">如何配置基于GTID的复制</h2>
<p>MySQL服务器的my.cnf配置文件中增加GTID相关的参数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">log_bin                        <span style="color:#f92672">=</span> /mysql/binlog/mysql_bin
log_slave_updates              <span style="color:#f92672">=</span> true
gtid_mode                      <span style="color:#f92672">=</span> ON 
enforce_gtid_consistency       <span style="color:#f92672">=</span> true 
relay_log_info_repository      <span style="color:#f92672">=</span> TABLE
relay_log_recovery             <span style="color:#f92672">=</span> ON 
</code></pre></div><p>然后在Slave上指定 <code>MASTER_AUTO_POSITION = 1</code> 执行 <code>CHANGE MASTER TO</code> 即可。比如:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">CHANGE MASTER <span style="color:#66d9ef">TO</span> MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;node1&#39;</span>,MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;repl&#39;</span>,MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;repl&#39;</span>,MASTER_AUTO_POSITION<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>; 
</code></pre></div><h2 id="基于gtid的复制如何工作">基于GTID的复制如何工作</h2>
<p>在 <code>MASTER_AUTO_POSITION = 1</code> 的情况下 ，MySQL会使用 <code>COM_BINLOG_DUMP_GTID</code> 协议进行复制。过程如下:</p>
<p>备库发起复制连接时，将自己的已接受和已执行的 <code>gtids</code> 的并集(后面称为<code>slave_gtid_executed</code>)发送给主库。即下面的集合:</p>
<pre><code>UNION(@@global.gtid_executed, Retrieved_gtid_set - last_received_GTID) 
</code></pre><p>主库将自己的 <code>gtid_executed</code> 与 <code>slave_gtid_executed</code> 的差集的 binlog 发送给 Slave。主库的 binlog dump 过程如下：</p>
<ol>
<li>检查 <code>slave_gtid_executed</code> 是否是主库 <code>gtid_executed</code> 的子集，如否那么主备数据可能不一致，报错。</li>
<li>检查主库的 <code>purged_executed</code> 是否是 <code>slave_gtid_executed</code> 的子集，如否代表缺失备库需要的binlog，报错</li>
<li>从最后一个 Binlog 开始扫描，获取文件头部的 <code>PREVIOUS_GTIDS_LOG_EVENT</code> ，如果它是<code>slave_gtid_executed</code> 的子集，则这是需要发送给Slave的第一个binlog文件，否则继续向前扫描。</li>
<li>从第3步找到的binlog文件的开头读取binlog记录，判断binlog记录是否已被包含在 <code>slave_gtid_executed</code>中，如果已包含跳过不发送。</li>
</ol>
<p>从上面的过程可知，在指定 <code>MASTER_AUTO_POSITION = 1</code>时，Master发送哪些binlog记录给Slave，取决于Slave的 <code>gtid_executed</code> 和 <code>Retrieved_Gtid_Set</code> 以及Master的 <code>gtid_executed</code>，和 <code>relay_log_info</code> 以及<code>master_log_info</code> 中保存的复制位点没有关系。</p>
<h2 id="如何修复复制错误">如何修复复制错误</h2>
<p>在基于GTID的复制拓扑中，要想修复 Slave 的 SQL 线程错误，过去的 <code>SQL_SLAVE_SKIP_COUNTER</code> 方式不再适用。需要通过设置 <code>gtid_next</code> 或 <code>gtid_purged</code> 完成，当然前提是已经确保主从数据一致，仅仅需要跳过复制错误让复制继续下去。比如下面的场景：</p>
<p>在从库上创建表 <code>tb1</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> sql_log_bin<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> <span style="color:#a6e22e">tb1</span>(id <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>,c1 <span style="color:#66d9ef">int</span>);
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">06</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> sql_log_bin<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec) 
</code></pre></div><p>在主库上创建表tb1</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> <span style="color:#a6e22e">tb1</span>(id <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>,c1 <span style="color:#66d9ef">int</span>);
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">06</span> sec) 
</code></pre></div><p>由于从库上这个表已经存在，从库的复制SQL线程出错停止。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> slave status<span style="color:#960050;background-color:#1e0010">\</span>G
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. row <span style="color:#f92672">***************************</span>
               Slave_IO_State: Waiting <span style="color:#66d9ef">for</span> master <span style="color:#66d9ef">to</span> send event
                  Master_Host: <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">125</span>.<span style="color:#ae81ff">134</span>
                  Master_User: sn_repl
                  Master_Port: <span style="color:#ae81ff">3306</span>
                Connect_Retry: <span style="color:#ae81ff">60</span>
              Master_Log_File: binlog.<span style="color:#ae81ff">000001</span>
          Read_Master_Log_Pos: <span style="color:#ae81ff">1422</span>
               Relay_Log_File: mysqld<span style="color:#f92672">-</span>relay<span style="color:#f92672">-</span>bin.<span style="color:#ae81ff">000003</span>
                Relay_Log_Pos: <span style="color:#ae81ff">563</span>
        Relay_Master_Log_File: binlog.<span style="color:#ae81ff">000001</span>
             Slave_IO_Running: Yes
            Slave_SQL_Running: No
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: <span style="color:#ae81ff">1050</span>
                   Last_Error: Error <span style="color:#e6db74">&#39;Table &#39;</span>tb1<span style="color:#e6db74">&#39; already exists&#39;</span> <span style="color:#66d9ef">on</span> query. <span style="color:#66d9ef">Default</span> <span style="color:#66d9ef">database</span>: <span style="color:#e6db74">&#39;test&#39;</span>. Query: <span style="color:#e6db74">&#39;create table tb1(id int primary key,c1 int)&#39;</span>
                 Skip_Counter: <span style="color:#ae81ff">0</span>
          Exec_Master_Log_Pos: <span style="color:#ae81ff">1257</span>
              Relay_Log_Space: <span style="color:#ae81ff">933</span>
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: <span style="color:#ae81ff">0</span>
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: <span style="color:#66d9ef">NULL</span>
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: <span style="color:#ae81ff">0</span>
                Last_IO_Error: 
               Last_SQL_Errno: <span style="color:#ae81ff">1050</span>
               Last_SQL_Error: Error <span style="color:#e6db74">&#39;Table &#39;</span>tb1<span style="color:#e6db74">&#39; already exists&#39;</span> <span style="color:#66d9ef">on</span> query. <span style="color:#66d9ef">Default</span> <span style="color:#66d9ef">database</span>: <span style="color:#e6db74">&#39;test&#39;</span>. Query: <span style="color:#e6db74">&#39;create table tb1(id int primary key,c1 int)&#39;</span>
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: <span style="color:#ae81ff">1</span>
                  Master_UUID: e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae
             Master_Info_File: mysql.slave_master_info
                    SQL_Delay: <span style="color:#ae81ff">0</span>
          SQL_Remaining_Delay: <span style="color:#66d9ef">NULL</span>
      Slave_SQL_Running_State: 
           Master_Retry_Count: <span style="color:#ae81ff">86400</span>
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: <span style="color:#ae81ff">161203</span> <span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">17</span>
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">5</span><span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>
            Executed_Gtid_Set: e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>
                Auto_Position: <span style="color:#ae81ff">1</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec) 
</code></pre></div><p>从上面的输出可以知道，从库已经执行过的事务是 <code>e10c75be-5c1b-11e6-ab7c-000c296078ae:1-5</code>，执行出错的事务是 <code>e10c75be-5c1b-11e6-ab7c-000c296078ae:6</code>，当前主备的数据其实是一致的，可以通过设置 <code>gtid_next</code>跳过这个出错的事务。</p>
<p>在从库上执行以下SQL:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> gtid_next<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;e10c75be-5c1b-11e6-ab7c-000c296078ae:6&#39;</span>;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> begin;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> commit;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> gtid_next<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;AUTOMATIC&#39;</span>;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> start slave;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec) 
</code></pre></div><p>设置 <code>gtid_next</code> 的方法一次只能跳过一个事务，要批量的跳过事务可以通过设置 <code>gtid_purged</code> 完成。假设下面的场景：</p>
<p>主库上已执行的事务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> master status;
<span style="color:#f92672">+---------------+----------+--------------+------------------+-------------------------------------------+</span>
<span style="color:#f92672">|</span> File          <span style="color:#f92672">|</span> Position <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span> Executed_Gtid_Set                         <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+-------------------------------------------+</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000001</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">2364</span> <span style="color:#f92672">|</span>              <span style="color:#f92672">|</span>                  <span style="color:#f92672">|</span> e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+-------------------------------------------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec) 
</code></pre></div><p>从库上已执行的事务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> master status;
<span style="color:#f92672">+---------------+----------+--------------+------------------+------------------------------------------+</span>
<span style="color:#f92672">|</span> File          <span style="color:#f92672">|</span> Position <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span> Executed_Gtid_Set                        <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+------------------------------------------+</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000001</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">1478</span> <span style="color:#f92672">|</span>              <span style="color:#f92672">|</span>                  <span style="color:#f92672">|</span> e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+------------------------------------------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec) 
</code></pre></div><p>假设经过修复从库已经和主库的数据一致了，但由于复制错误Slave的SQL线程依然处于停止状态。现在可以通过把从库的 <code>gtid_purged</code> 设置为和主库的 <code>gtid_executed</code> 一样跳过不一致的GTID使复制继续下去，步骤如下。</p>
<p>在从库上执行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> reset master;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> GLOBAL gtid_purged<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;e10c75be-5c1b-11e6-ab7c-000c296078ae:1-10&#39;</span>;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">03</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> master status;
<span style="color:#f92672">+---------------+----------+--------------+------------------+-------------------------------------------+</span>
<span style="color:#f92672">|</span> File          <span style="color:#f92672">|</span> Position <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span> Executed_Gtid_Set                         <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+-------------------------------------------+</span>
<span style="color:#f92672">|</span> binlog.<span style="color:#ae81ff">000002</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">191</span> <span style="color:#f92672">|</span>              <span style="color:#f92672">|</span>                  <span style="color:#f92672">|</span> e10c75be<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>c1b<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e6<span style="color:#f92672">-</span>ab7c<span style="color:#f92672">-</span><span style="color:#ae81ff">000</span>c296078ae:<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+---------------+----------+--------------+------------------+-------------------------------------------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec) 
</code></pre></div><p>此时从库的Executed_Gtid_Set已经包含了主库上&rsquo;1-10'的事务，再开启复制会从后面的事务开始执行，就不会出错了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> start slave;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec) 
</code></pre></div><p>使用gtid_next和gtid_purged修复复制错误的前提是，跳过那些事务后仍可以确保主备数据一致。如果做不到，就要考虑pt-table-sync或者拉备份的方式了。</p>
<h2 id="read-more">Read More</h2>
<ul>
<li>
<p>官方文档 <a href="https://dev.mysql.com/doc/refman/5.6/en/replication-gtids-concepts.html">16.1.3.1 GTID Format and Storage</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/wukong_666/article/details/79311743">MySQL传统复制与GTID复制的原理阐述</a></p>
</li>
<li>
<p><code>GTID site:mysql.taobao.org</code></p>
</li>
<li>
<p>本文主要来自 <a href="https://blog.csdn.net/anzhen0429/article/details/77658663">MySQL的GTID复制比传统复制的优势</a></p>
<ul>
<li>GTID与备份恢复
<ul>
<li>通过mysqldump进行备份</li>
<li>通过Xtrabackup进行备份</li>
</ul>
</li>
<li>GTID与MHA</li>
<li>GTID与crash safe slave
<ul>
<li>基于binlog文件位置的复制</li>
<li>基于GTID的复制</li>
<li>设置&quot;双1&quot;对性能的影响</li>
<li>如何在非&quot;双1&quot;下保证crash safe slave</li>
<li>MTS下特有的问题</li>
<li>Master的crash safe</li>
</ul>
</li>
</ul>
</li>
<li></li>
</ul>
</article>

      
<div class="book-footer justify-between">
  
  <div>
    
    <a href="https://github.com/hello-world-example/MySQL/commit/71ec2a7452a732175c6c2de4894addafcab396a7" title='Last modified Sep 14, 2019 by kailbin' target="_blank" rel="noopener">
      <img src="/MySQL/svg/calendar.svg" alt="Changed" /> Sep 14, 2019
    </a>
  </div>
  
  
  <div>
    <a href="https://github.com/hello-world-example/MySQL/edit/master/HuGo/content/docs/Binlog/Gtid.md" target="_blank" rel="noopener">
      <img src="/MySQL/svg/edit.svg" alt="Edit" /> Edit this page
    </a>
  </div>
  
</div>


      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#gtid长什么样">GTID长什么样</a></li>
    <li><a href="#如何查看gtid">如何查看GTID</a></li>
    <li><a href="#如何产生gtid">如何产生GTID</a></li>
    <li><a href="#gtid限制">GTID限制</a></li>
    <li><a href="#gtid的持久化">GTID的持久化</a></li>
    <li><a href="#如何配置基于gtid的复制">如何配置基于GTID的复制</a></li>
    <li><a href="#基于gtid的复制如何工作">基于GTID的复制如何工作</a></li>
    <li><a href="#如何修复复制错误">如何修复复制错误</a></li>
    <li><a href="#read-more">Read More</a></li>
  </ul>
</nav>
  </aside>



  </main>
  
  
  
</body>

</html>
